<?xml version="1.0" encoding="UTF-8" ?>
<funcs>

    <func id="0" name="GetPass" des="从TOKEN中取pass" private="true">
        <string name="token" must="true" len="64-64"/>

        <job result="userInfo" type="single">select * from user where token = ${token}</job>
        <job>Eq(${userInfo},null,'该用户不存在')</job>
        <job>Jget(${userInfo},'pass','key')</job>
    </func>

    <func id="1" name="GetSession" des="根据session的值，获取解密该session的密码" private="true">
        <string name="token" must="true" len="20-60"/>

        <job result="session">GetSession(${token})</job>
        <job>Eq(${session},null,'用户会话已过期，请重新登陆')</job>
        <job>Jget(${session},'id','pass')</job>
    </func>

    <func id="10" name="GetSalt" des="获取密码的盐值">

        <job type="single">select salt from user where token = ${token}</job>
        <job>Jget(${1},'salt')</job>
    </func>

    <func id="11" name="LoginIn" des="登陆">
        <string name="token" must="true" len="64-64"/>
        <string name="x" must="true" len="20-50"/>
        <string name="y" must="true" len="20-50"/>

        <job result="userInfo" type="single">select id,session oldSession from user where token = ${token}</job>
        <job result="oldSession">Jget(${userInfo},'oldSession')</job>
        <job test="Neq(${oldSession},null)">DelSession(${oldSession})</job>

        <job result="id">Jget(${userInfo},'id')</job>
        <job result="login">LoginIn(${x},${y},${id})</job>
        <job result="session">Jget(${login},'session')</job>
        <job result="pass">Jget(${login},'pass')</job>
        <job result="json">Jset('id',${id},'session',${session},'pass',${pass})</job>
        <job>update user set session = ${session} where id = ${id}</job>
        <job>SetSession(${session},${json})</job>
        <job>Jget(${login},'session','x','y')</job>
    </func>

    <func id="12" name="LoginOut" des="登出">
        <job>DelSession(${token})</job>
    </func>

    <func id="13" name="register" des="用TOKEN来注册" self="true">
        <string name="token" must="true" len="64-64"/>
        <string name="pass" must="true" len="20-32"/>
        <string name="salt" must="true" len="20-32"/>
        <string name="key" must="true" len="20-32"/>
        <string name="tel" len="0-20"/>
        <string name="nick" len="0-64"/>
        <string name="portrait" len="0-128"/>
        <int name="parent"/>

        <job type="single">select count(*) count from user where token = ${token}</job>
        <job>Jget(${1},'count')</job>
        <job>Eq(${2},1,'账号已存在，可以直接登陆')</job>
        <job>insert into user values(null,${tel},${nick},${portrait},${token},${pass},${salt},${key},${parent},null)</job>

    </func>

</funcs>
