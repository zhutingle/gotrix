<?xml version="1.0" encoding="UTF-8" ?>
<funcs>

	<func id="2000" name="access_token" des="从微信公众平台获取access_token" private="true" cron="0 0 * * * *">
		<job result="ttl">ttl('access_token')</job>
		<job>G(${ttl},1000,'access_token 暂时不需要更新')</job>

		<job result="appid">Config('Appid')</job>
		<job result="appSecret">Config('AppSecret')</job>
		<job result="url"><![CDATA[Sprintf('https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s',${appid},${appSecret})]]></job>
		<job result="result">HttpGet(${url})</job>
		<job result="json">ToJson(${result})</job>

		<job result="access_token">Jget(${json},'access_token')</job>
		<job result="expires_in">Jget(${json},'expires_in')</job>
		<job>setex('access_token',4200,${access_token})</job>
	</func>

	<func id="2001" name="sendNewOrderSuccess" des="发送模板消息(新生成订单)" private="true">
		<int name="orderid" must="true" />

		<job result="info" one="true">select
			orders.time,`user`.openid,
			GROUP_CONCAT(CONCAT(goods.name,IF(ISNULL(shopping.attach),'',CONCAT('(',shopping.attach,')')),' X',shopping.count) SEPARATOR ';') goods
			from orders,shopping,goods,`user`
			where orders.id = ${orderid} and orders.id = shopping.orderid and shopping.goodid = goods.id and orders.userid = `user`.id
		</job>
		<job result="time">Jget(${info},'time')</job>
		<job result="openid">Jget(${info},'openid')</job>
		<job result="goods">Jget(${info},'goods')</job>

		<job result="access_token">get('access_token')</job>
		<job result="url"><![CDATA[Sprintf('https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%v',${access_token})]]></job>
		<job result="first">Jset('color','#173177','value','和风坊新订单生成通知，点击支付')</job>
		<job result="keyword1">Jset('color','#173177','value',${time})</job>
		<job result="keyword2">Jset('color','#173177','value',${goods})</job>
		<job result="keyword3">Jset('color','#173177','value',${orderid})</job>
		<job result="remark">Jset('color','#173177','value','和风坊感谢您的支持。')</job>
		<job result="data">Jset('first',${first},'keyword1',${keyword1},'keyword2',${keyword2},'keyword3',${keyword3},'remark',${remark})</job>
		<job result="openUrl">Sprintf('http://thribu.randiancx.com/order.html?id=%v',${orderid})</job>
		<job result="param">Jset('touser',${openid},'template_id','Z5fjrOOl9lf5hB15KI6OtVIx93pvfGK9JXG19EJI-mM','url',${openUrl},'data',${data})</job>
		<job result="resp">HttpPost(${url},${param})</job>
	</func>

	<func id="2002" name="sendPaySuccess" des="发送模板消息(订单支付成功)" private="true">
		<int name="orderid" must="true" />

		<job result="info" one="true">select
			orders.money,`user`.openid,
			GROUP_CONCAT(CONCAT(goods.name,IF(ISNULL(shopping.attach),'',CONCAT('(',shopping.attach,')')),' X',shopping.count) SEPARATOR ';') goods
			from orders,shopping,goods,`user`
			where orders.id = ${orderid} and orders.id = shopping.orderid and shopping.goodid = goods.id and orders.userid = `user`.id
		</job>
		<job result="money">Jget(${info},'money')</job>
		<job result="openid">Jget(${info},'openid')</job>
		<job result="goods">Jget(${info},'goods')</job>

		<job result="access_token">get('access_token')</job>
		<job result="url"><![CDATA[Sprintf('https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%v',${access_token})]]></job>
		<job result="first">Jset('color','#173177','value','你好，您的订单已经支付成功')</job>
		<job result="keyword1">Jset('color','#173177','value',${goods})</job>
		<job result="keyword2">Jset('color','#173177','value',${orderid})</job>
		<job result="keyword3">Jset('color','#173177','value',${money})</job>
		<job result="remark">Jset('color','#173177','value','和风坊感谢您的支持。')</job>
		<job result="data">Jset('first',${first},'keyword1',${keyword1},'keyword2',${keyword2},'keyword3',${keyword3},'remark',${remark})</job>
		<job result="openUrl">Sprintf('http://thribu.randiancx.com/order.html?id=%v',${orderid})</job>
		<job result="param">Jset('touser',${openid},'template_id','koohwqVODPVbtu3KC-dSFItEsoIcRprEgNa8Wg-vRG8','url',${openUrl},'data',${data})</job>
		<job result="resp">HttpPost(${url},${param})</job>
	</func>

	<func id="2003" name="newUserLogin" des="新会员注册首次登陆" private="true">
		<int name="userid" must="true" />

		<job result="info" one="true">select nick,openid,parent from user where id = ${userid}</job>
		<job result="nick">Jget(${info},'nick')</job>
		<job result="openid">Jget(${info},'openid')</job>
		<job result="parent">Jget(${info},'parent')</job>

		<job result="pInfo" one="true">select nick,openid from user where id = ${parent}</job>
		<job result="pNick" test="Neq(${pInfo},null)">Jget(${pInfo},'nick')</job>
		<job result="pOpenid" test="Neq(${pInfo},null)">Jget(${pInfo},'openid')</job>

		<job result="access_token">get('access_token')</job>
		<job result="url"><![CDATA[Sprintf('https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=%v',${access_token})]]></job>
		<job result="first">Jset('color','#173177','value','和风坊新会员注册成功')</job>
		<job result="keyword1" test="Neq(${pNick},null)">Jset('color','#173177','value',${pNick})</job>
		<job result="keyword1" test="Eq(${pNick},null)">Jset('color','#173177','value','无')</job>
		<job result="keyword2">Jset('color','#173177','value',${nick})</job>
		<job result="remark">Jset('color','#173177','value','感谢加入和风坊')</job>
		<job result="data">Jset('first',${first},'keyword1',${keyword1},'keyword2',${keyword2},'remark',${remark})</job>
		<job result="openUrl">Sprintf('http://thribu.randiancx.com/store.html')</job>
		<job result="param">Jset('touser',${openid},'template_id','hMIhBBsAE8GwDrgLXGM35j96ekxnC0A_1p34X9xw4yM','url',${openUrl},'data',${data})</job>
		<job result="resp">HttpPost(${url},${param})</job>

		<job result="pParam" test="Neq(${pOpenid},null)">Jset('touser',${pOpenid},'template_id','hMIhBBsAE8GwDrgLXGM35j96ekxnC0A_1p34X9xw4yM','url',${openUrl},'data',${data})</job>
		<job result="resp">HttpPost(${url},${pParam})</job>
	</func>

</funcs>
