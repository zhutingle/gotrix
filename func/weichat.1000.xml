<?xml version="1.0" encoding="UTF-8" ?>
<funcs>

	<func id="1000" name="weichatPay" des="发起微信支付">
		<string name="_ip" must="true" />
		<int name="orderId" must="true" />
		<string name="body" must="true" len="0-256" />
		<string name="remark" len="0-100" />

		<!-- 第一步：计算总价格，并写入订单表中 -->
		<job result="today">Tformat('20060102')</job>
		<job result="orderno">Sprintf('%v%05v',${today},${orderId})</job>
		<job>update orders set remark = ${remark},orderno = ${orderno},money = (select sum(count*price) from shopping,goods where shopping.goodid = goods.id and shopping.userid = ${userid} and shopping.orderid = ${orderId}) where userid = ${userid} and id = ${orderId}</job>

		<!-- 构建统一下单接口所需参数 -->
		<job result="info" one="true">select user.openid,cast(orders.money*100 as SIGNED) money from user,orders where user.id = orders.userid and orders.id = ${orderId} and orders.userid = ${userid}</job>
		<job result="openid">Jget(${info},'openid')</job>
		<job result="total_fee">Jget(${info},'money')</job>

		<job result="Appid">Config('Appid')</job>
		<job result="Mch_id">Config('Mch_id')</job>
		<job result="Notify_url">Config('Notify_url')</job>
		<job result="Trade_type">Config('Trade_type')</job>
		<job result="Nonce_str">Rstring(32)</job>
		<job result="weichatParam">Jset('appid',${Appid},'mch_id',${Mch_id},'notify_url',${Notify_url},'trade_type',${Trade_type},'nonce_str',${Nonce_str},'body',${body},'total_fee',${total_fee},'openid',${openid},'out_trade_no',${orderno},'spbill_create_ip',${_ip})</job>

		<!-- 对参数进行签名 -->
		<job result="Key">Config('Key')</job>
		<job result="sign">WeichatSign(${weichatParam},${Key})</job>
		<job>Jset(${weichatParam},'sign',${sign})</job>

		<!-- 请求微信服务器的统一下单接口 -->
		<job result="weichatResult">WeichatPay(${weichatParam})</job>
		<job result="resultCode">Jget(${weichatResult},'result_code')</job>
		<job result="returnMsg">Jget(${weichatResult},'return_msg')</job>
		<job>Eq(${resultCode},'FAIL',${returnMsg})</job>

		<!-- 验证接口返回的签名是否正确 -->
		<job result="sign">Jget(${weichatResult},'sign')</job>
		<job>Jset(${weichatResult},'sign',null)</job>
		<job result="localSign">WeichatSign(${weichatResult},${Key})</job>
		<job>Jset('localSign',${localSign},'sign',${sign})</job>

		<!-- 构建微信HTML页面所需要参数 -->
		<job result="timeStamp">Tsecond()</job>
		<job result="prepay_id">Jget(${weichatResult},'prepay_id')</job>
		<job result="package">Sprintf('prepay_id=%s',${prepay_id})</job>
		<job result="htmlParam">Jset('appId',${Appid},'timeStamp',${timeStamp},'package',${package},'nonceStr',${Nonce_str},'signType','MD5')</job>
		<job result="sign">WeichatSign(${htmlParam},${Key})</job>
		<job>Jset(${htmlParam},'paySign',${sign})</job>

		<!-- 将参数写入到页面并返回 -->
		<job result="htmlParamString">ToString(${htmlParam})</job>
		<job result="returnHtml"><![CDATA[Sprintf('<html><head><title>正在进行微信支付...</title></head><body><script type="text/javascript">function onBridgeReady() {WeixinJSBridge.invoke("getBrandWCPayRequest", %v, function(res) {if (res.err_msg == "get_brand_wcpay_request：ok") {history.back();} else {history.back();}});}if (typeof WeixinJSBridge == "undefined") {if (document.addEventListener) {document.addEventListener("WeixinJSBridgeReady", onBridgeReady, false);}else if (document.attachEvent) {document.attachEvent("WeixinJSBridgeReady",onBridgeReady);document.attachEvent("onWeixinJSBridgeReady", onBridgeReady);}} else {onBridgeReady();}</script></body></html>',${htmlParamString})]]></job>
		<job>Return(${returnHtml})</job>
	</func>

	<func id="1001" name="weichatCallback" des="微信支付回调" private="true">

		<!-- 验证签名是否正确 -->
		<job result="sign">Jget(${weichat},'sign')</job>
		<job>Jset(${weichat},'sign',null)</job>
		<job result="Key">Config('Key')</job>
		<job result="localSign">WeichatSign(${weichat},${Key})</job>
		<job test="Neq(${sign},${localSign})"><![CDATA[Return('<xml><return_code>FAIL</return_code><return_msg>签名sign错误</return_msg></xml>')]]></job>

		<!-- 判断业务是否已经被处理 -->
		<job result="orderno">Jget(${weichat},'out_trade_no')</job>
		<job result="orderInfo" one="true">select id,state from orders where orderno = ${orderno}</job>
		<job result="state">Jget(${orderInfo},'state')</job>
		<job result="orderid">Jget(${orderInfo},'id')</job>
		<job test="Neq(${state},1)"><![CDATA[Return('<xml><return_code>FAIL</return_code><return_msg>该订单号已经被处理</return_msg></xml>')]]></job>

		<!-- 更新订单状态 -->
		<job>update orders set state = 2 where id = ${orderid}</job>
		<!-- 一级分成 -->
		<job result="pInfo" one="true">select user2.id,orders.money * discount.level1 money1,orders.money * discount.level2 money2,orders.money * discount.level3 money3
			from user user1,user user2,orders,discount
			where user1.id = orders.userid and orders.id = ${orderid} and discount.id = 1 and user1.parent = user2.id
		</job>
		<job result="pId" test="Neq(${pInfo},null)">Jget(${pInfo}, 'id')</job>
		<job result="money1" test="Neq(${pInfo},null)">Jget(${pInfo},'money1')</job>
		<job test="Neq(${pId},null)">insert into recode(userid,orderid,level,score,state) values(${pId},${orderid},1,${money1},0)</job>

		<!-- 二级分成 -->
		<job result="ppInfo" test="Neq(${pId},null)" one="true">select user2.id from user user1, user user2 where user1.id = ${pId} and user1.parent = user2.id</job>
		<job result="ppId" test="Neq(${ppInfo},null)">Jget(${ppInfo},'id')</job>
		<job result="money2" test="Neq(${pInfo},null)">Jget(${pInfo},'money2')</job>
		<job test="Neq(${ppId},null)">insert into recode(userid,orderid,level,score,state) values(${ppId},${orderid},2,${money2},0)</job>

		<!-- 三级分成 -->
		<job result="pppInfo" test="Neq(${ppId},null)" one="true">select user2.id from user user1,user user2 where user1.id = ${ppId} and user1.parent = user2.id</job>
		<job result="pppId" test="Neq(${pppInfo},null)">Jget(${pppInfo},'id')</job>
		<job result="money3" test="Neq(${pInfo},null)">Jget(${pInfo},'money3')</job>
		<job test="Neq(${pppId},null)">insert into recode(userid,orderid,level,score,state) values(${pppId},${orderid},3,${money3},0)</job>

		<job result="param">Jset('orderid',${orderid})</job>
		<job>SyncCall(2002,${param})</job>

		<job><![CDATA[Return('<xml><return_code>SUCCESS</return_code><return_msg>OK</return_msg></xml>')]]></job>
	</func>

	<func id="1002" name="recodeToMoney" des="积分兑换红包">
		<int name="score" must="true" val="100-20000" />

		<!-- 判断用户的积分是否足够本次兑换 -->
		<job result="userInfo" one="true">select (score >= ${score}) as canChange,openid,nick from user where id = ${userid}</job>
		<job result="canChange">Jget(${userInfo},'canChange')</job>
		<job>Neq(${canChange},1,'您的积分不足')</job>

		<!-- 插入用户兑换记录，暂时先将记录设置为未成功 -->
		<job result="exchangeId">insert into exchange(id,userid,score,time,state) values(null,${userid},${score},now(),0)</job>
		<!-- 数据更新，数据先更新，再向微信服务器请求发红包接口，是为了防止微信红包接口可能出现问题而导致用户未扣费 -->
		<job>update user,exchange set user.score = user.score - ${score}, exchange.state = 1 where user.id = ${userid} and user.id = exchange.userid and exchange.id = ${exchangeId}</job>

		<!-- 组装微信红包所需参数并签名 -->
		<job result="wxappid">Config('Appid')</job>
		<job result="mch_id">Config('Mch_id')</job>
		<job result="nonce_str">Rstring(32)</job>
		<job result="re_openid">Jget(${userInfo},'openid')</job>
		<job result="nick">Jget(${userInfo},'nick')</job>
		<job result="today">Tformat('20060102')</job>
		<job result="tempExchangeId">Sprintf('%s%010d',${today},${exchangeId})</job>
		<job result="mch_billno">Sprintf('%s%s',${mch_id},${tempExchangeId})</job>
		<job result="exchangeParam">Jset('wxappid',${wxappid},'mch_id',${mch_id},'nonce_str',${nonce_str},'send_name','和风坊','re_openid',${re_openid},'total_num','1','total_amount',${score},'wishing','感谢您对和风坊的支持！','client_ip',${_ip},'act_name','积分兑换红包','remark',${nick},'mch_billno',${mch_billno})</job>
		<job result="Key">Config('Key')</job>
		<job result="sign">WeichatSign(${exchangeParam},${Key})</job>
		<job>Jset(${exchangeParam},'sign',${sign})</job>

		<!-- 向微信服务器请求发红包接口 -->
		<job result="exchangeResult">WxSendRedPack(${exchangeParam})</job>

		<job test="Eq(${exchangeResult},null)">update exchange set state = 2 where userid = ${userid} and id = ${exchangeId}</job>
		<job>Eq(${exchangeResult},null,'向微信服务器请求红包接口时异常，请稍后再试')</job>
		<!-- 判断接口返回的结果是否正确 -->
		<job result="return_code">Jget(${exchangeResult},'return_code')</job>
		<job result="return_msg">Jget(${exchangeResult},'return_msg')</job>
		<job test="Neq(${return_code},'SUCCESS')">update exchange set state = 2 where userid = ${userid} and id = ${exchangeId}</job>
		<job>Neq(${return_code},'SUCCESS',${return_msg})</job>

		<job>Jset('success',1)</job>

	</func>

	<func id="1003" name="selectExchange" des="查询兑换红包记录">

		<job result="exchangeState">select value,text from dicti where dictid = 7</job>
		<job result="exchange">select user.nick,user.portrait,exchange.time,exchange.score,exchange.state from user,exchange where user.id = ${userid} and user.id = exchange.userid order by exchange.time desc limit 0,10</job>
		<job>Jset('exchange',${exchange},'exchangeState',${exchangeState})</job>
	</func>

	<func id="1004" name="exportOrders" des="导出订单记录并自动发送邮箱" private="true" cron="0 0 17 * * *">

		<job result="orderData">select orders.id,orders.name,orders.tel,orders.detail,
			GROUP_CONCAT(CONCAT(goods.name,IF(ISNULL(shopping.attach),'',CONCAT('(',shopping.attach,')')),' X',shopping.count) SEPARATOR ';') goods,
			orders.orderno
			from orders,shopping,goods
			where orders.state = 2 and orders.id = shopping.orderid and shopping.goodid = goods.id group by orders.id order by orders.id
		</job>
		<job result="maxIdOrder">JAget(${orderData},-1)</job>
		<job>Eq(${maxIdOrder},null,'今日没有订单记录')</job>

		<job result="fileName">Tformat('20060102')</job>
		<job result="filePath">ToXls(${orderData},'id,name,tel,detail,goods,orderno',${fileName})</job>

		<job result="maxId" test="Neq(${maxIdOrder},null)">Jget(${maxIdOrder},'id')</job>
		<job result="orderCount" test="Neq(${maxIdOrder},null)"><![CDATA[update orders set state = 3 where state = 2 and id <= ${maxId}]]></job>

		<job result="subject">Sprintf('%s订单记录',${fileName})</job>
		<job result="body">Sprintf('和风坊%s订单记录',${fileName})</job>
		<job result="group" one="true">select group_concat(email SEPARATOR ',') as receiver from receiver where type = 1</job>
		<job result="receiver">Jget(${group},'receiver')</job>
		<job>SendEmail(${subject},${body},${receiver},${filePath})</job>
	</func>

	<func id="1005" name="weichatRefund" des="微信退款接口">
		<int name="orderId" must="true" />

		<job result="today">Tformat('20060102')</job>
		<!-- 判断订单是否符合退款要求 -->
		<job result="orderInfo" one="true">select orderno,state,refundno,cast(orders.money*100 as SIGNED) total from orders where id = ${orderId}</job>
		<job result="state">Jget(${orderInfo},'state')</job>
		<job>Eq(${orderInfo},null,'此订单不存在。')</job>
		<job>Neq(${state},2,'您的订单已经配货或已经发货，暂时不能退款，请收到商品之后再联系客服退货退款。')</job>

		<!-- 构造微信退款接口所需参数并且进行微信签名 -->
		<job result="appid">Config('Appid')</job>
		<job result="mch_id">Config('Mch_id')</job>
		<job result="nonce_str">Rstring(32)</job>
		<job result="out_trade_no">Jget(${orderInfo},'orderno')</job>
		<job result="refundno">Jget(${orderInfo},'refundno')</job>
		<job result="out_refund_no" test="Eq(${refundno},null)">Sprintf('%v%05v',${today},${orderId})</job>
		<job test="Eq(${refundno},null)">update orders set refundno = ${out_refund_no} where id = ${orderId}</job>
		<job result="out_refund_no" test="Neq(${refundno},null)">Jget(${orderInfo},'refundno')</job>
		<job result="total_fee">Jget(${orderInfo},'total')</job>
		<job result="refund_fee">Jget(${orderInfo},'total')</job>
		<job result="weichatParam">Jset('appid',${appid},'mch_id',${mch_id},'device_info','WEB','nonce_str',${nonce_str},'sign_type','MD5','out_trade_no',${out_trade_no},'out_refund_no',${out_refund_no},'total_fee',${total_fee},'refund_fee',${refund_fee},'op_user_id',${mch_id},'refund_channel','ORIGINAL')</job>
		<job result="key">Config('Key')</job>
		<job result="sign">WeichatSign(${weichatParam},${key})</job>
		<job result="weichatParam">Jset(${weichatParam},'sign',${sign})</job>

		<!-- 调用微信退款接口 -->
		<job result="weichatResult">WxCertRequest(${weichatParam},'https://api.mch.weixin.qq.com/secapi/pay/refund')</job>
		<!-- <job result="weichatResult">Jset('sign','9E816A14643741BE12B7878EC8190164','result_code','SUCCESS','transaction_id','4005262001201612061965835562','return_code','SUCCESS','appid','wx32e598477c7d1ef8','nonce_str','Ecl7xK79LTbN15fC','out_trade_no','2016120600063','out_refund_no','2016120600063','refund_id','2005262001201612060630094593','refund_channel','ORIGINAL','return_msg','OK','mch_id','1384831502')</job> -->

		<!-- 如果微信退款接口返回失败，则提示 -->
		<!-- <job result="returnCode">Jget(${weichatResult},'return_code')</job> -->
		<!-- <job result="returnMsg">Jget(${weichatResult},'return_msg')</job> -->
		<!-- <job>Eq(${returnCode},'FAIL',${returnMsg})</job> -->

		<!-- 验证接口返回的签名是否正确，若不正确，则提示 -->
		<!-- <job result="sign">Jget(${weichatResult},'sign')</job> -->
		<!-- <job result="localSign">WeichatSign(${weichatResult},${key})</job> -->
		<!-- <job>Jset('localSign',${localSign},'sign',${sign})</job> -->
		<!-- <job>Neq(${localSign},${sign},'在微信退款时出现异常，请稍候再试。')</job> -->

		<!-- 修改状态 -->
		<!-- <job>Jset(${weichatResult},'test','test')</job> -->
	</func>

</funcs>
